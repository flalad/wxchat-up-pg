<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå°è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f7;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #1d1d1f;
        }
        .test-button {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.danger {
            background: #ff3b30;
        }
        .test-button.danger:hover {
            background: #d70015;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .login-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        .login-form input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.online {
            background: #34c759;
        }
        .status-indicator.offline {
            background: #ff3b30;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç®¡ç†åå°è°ƒè¯•é¡µé¢</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•å’Œè°ƒè¯•ç®¡ç†åå°çš„APIæ¥å£é—®é¢˜</p>

        <!-- ç™»å½•æµ‹è¯• -->
        <div class="debug-section">
            <h3>ğŸ” ç™»å½•æµ‹è¯•</h3>
            <div class="login-form">
                <input type="text" id="username" placeholder="ç”¨æˆ·å" value="admin">
                <input type="password" id="password" placeholder="å¯†ç " value="">
                <button class="test-button" onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
                <button class="test-button" onclick="testLogout()">é€€å‡ºç™»å½•</button>
            </div>
            <div>
                <span class="status-indicator" id="authStatus"></span>
                <span id="authStatusText">æœªç™»å½•</span>
            </div>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <!-- APIæµ‹è¯• -->
        <div class="debug-section">
            <h3>ğŸ“Š APIæ¥å£æµ‹è¯•</h3>
            <button class="test-button" onclick="testDashboard()">æµ‹è¯•ä»ªè¡¨æ¿</button>
            <button class="test-button" onclick="testUsers()">æµ‹è¯•ç”¨æˆ·åˆ—è¡¨</button>
            <button class="test-button" onclick="testMessages()">æµ‹è¯•æ¶ˆæ¯åˆ—è¡¨</button>
            <button class="test-button" onclick="testFiles()">æµ‹è¯•æ–‡ä»¶åˆ—è¡¨</button>
            <div id="apiResult" class="result" style="display: none;"></div>
        </div>

        <!-- ç”¨æˆ·æ“ä½œæµ‹è¯• -->
        <div class="debug-section">
            <h3>ğŸ‘¥ ç”¨æˆ·æ“ä½œæµ‹è¯•</h3>
            <div style="margin-bottom: 10px;">
                <input type="number" id="testUserId" placeholder="ç”¨æˆ·ID" value="1">
                <button class="test-button" onclick="testUserUpdate()">æµ‹è¯•æ›´æ–°ç”¨æˆ·</button>
                <button class="test-button danger" onclick="testUserDelete()">æµ‹è¯•åˆ é™¤ç”¨æˆ·</button>
            </div>
            <div id="userOpResult" class="result" style="display: none;"></div>
        </div>

        <!-- ç½‘ç»œè¯Šæ–­ -->
        <div class="debug-section">
            <h3>ğŸŒ ç½‘ç»œè¯Šæ–­</h3>
            <button class="test-button" onclick="testNetworkConnectivity()">æµ‹è¯•ç½‘ç»œè¿æ¥</button>
            <button class="test-button" onclick="testCORS()">æµ‹è¯•CORS</button>
            <button class="test-button" onclick="showNetworkInfo()">æ˜¾ç¤ºç½‘ç»œä¿¡æ¯</button>
            <div id="networkResult" class="result" style="display: none;"></div>
        </div>

        <!-- ç³»ç»Ÿä¿¡æ¯ -->
        <div class="debug-section">
            <h3>ğŸ’» ç³»ç»Ÿä¿¡æ¯</h3>
            <button class="test-button" onclick="showSystemInfo()">æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯</button>
            <button class="test-button" onclick="showConsoleErrors()">æ˜¾ç¤ºæ§åˆ¶å°é”™è¯¯</button>
            <div id="systemResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let consoleErrors = [];

        // æ•è·æ§åˆ¶å°é”™è¯¯
        const originalConsoleError = console.error;
        console.error = function(...args) {
            consoleErrors.push({
                timestamp: new Date().toISOString(),
                message: args.join(' ')
            });
            originalConsoleError.apply(console, args);
        };

        // æ›´æ–°è®¤è¯çŠ¶æ€æ˜¾ç¤º
        function updateAuthStatus() {
            const statusIndicator = document.getElementById('authStatus');
            const statusText = document.getElementById('authStatusText');
            
            if (sessionId) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'å·²ç™»å½•';
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'æœªç™»å½•';
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // APIè¯·æ±‚å‡½æ•°
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (sessionId) {
                defaultOptions.headers['Authorization'] = `Bearer ${sessionId}`;
            }

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            try {
                const response = await fetch(url, finalOptions);
                const result = await response.json();
                
                return {
                    status: response.status,
                    ok: response.ok,
                    data: result
                };
            } catch (error) {
                return {
                    status: 0,
                    ok: false,
                    error: error.message
                };
            }
        }

        // æµ‹è¯•ç™»å½•
        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showResult('loginResult', 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            const result = await apiRequest('/api/auth/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            if (result.ok && result.data.success) {
                sessionId = result.data.data.sessionId;
                updateAuthStatus();
                showResult('loginResult', `ç™»å½•æˆåŠŸï¼\nä¼šè¯ID: ${sessionId}\nç”¨æˆ·: ${result.data.data.user.username}\nè§’è‰²: ${result.data.data.user.role}`, 'success');
            } else {
                showResult('loginResult', `ç™»å½•å¤±è´¥ï¼\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${result.data?.error || result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }

        // æµ‹è¯•é€€å‡ºç™»å½•
        function testLogout() {
            sessionId = null;
            updateAuthStatus();
            showResult('loginResult', 'å·²é€€å‡ºç™»å½•', 'info');
        }

        // æµ‹è¯•ä»ªè¡¨æ¿
        async function testDashboard() {
            if (!sessionId) {
                showResult('apiResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const result = await apiRequest('/api/admin/dashboard');
            
            if (result.ok && result.data.success) {
                const stats = result.data.data.totalStats;
                showResult('apiResult', `ä»ªè¡¨æ¿æ•°æ®è·å–æˆåŠŸï¼\nç”¨æˆ·æ•°: ${stats.users}\næ¶ˆæ¯æ•°: ${stats.messages}\næ–‡ä»¶æ•°: ${stats.files}\nå­˜å‚¨: ${(stats.fileSize / 1024 / 1024).toFixed(2)} MB`, 'success');
            } else {
                showResult('apiResult', `ä»ªè¡¨æ¿æ•°æ®è·å–å¤±è´¥ï¼\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${result.data?.error || result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }

        // æµ‹è¯•ç”¨æˆ·åˆ—è¡¨
        async function testUsers() {
            if (!sessionId) {
                showResult('apiResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const result = await apiRequest('/api/admin/users?page=1&limit=5');
            
            if (result.ok && result.data.success) {
                const users = result.data.data.users;
                const pagination = result.data.data.pagination;
                showResult('apiResult', `ç”¨æˆ·åˆ—è¡¨è·å–æˆåŠŸï¼\nç”¨æˆ·æ•°é‡: ${users.length}\næ€»è®¡: ${pagination.total}\né¡µæ•°: ${pagination.totalPages}`, 'success');
            } else {
                showResult('apiResult', `ç”¨æˆ·åˆ—è¡¨è·å–å¤±è´¥ï¼\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${result.data?.error || result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }

        // æµ‹è¯•æ¶ˆæ¯åˆ—è¡¨
        async function testMessages() {
            if (!sessionId) {
                showResult('apiResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const result = await apiRequest('/api/admin/messages?page=1&limit=5');
            
            if (result.ok && result.data.success) {
                const messages = result.data.data.messages;
                const pagination = result.data.data.pagination;
                showResult('apiResult', `æ¶ˆæ¯åˆ—è¡¨è·å–æˆåŠŸï¼\næ¶ˆæ¯æ•°é‡: ${messages.length}\næ€»è®¡: ${pagination.total}\né¡µæ•°: ${pagination.totalPages}`, 'success');
            } else {
                showResult('apiResult', `æ¶ˆæ¯åˆ—è¡¨è·å–å¤±è´¥ï¼\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${result.data?.error || result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }

        // æµ‹è¯•æ–‡ä»¶åˆ—è¡¨
        async function testFiles() {
            if (!sessionId) {
                showResult('apiResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const result = await apiRequest('/api/admin/files?page=1&limit=5');
            
            if (result.ok && result.data.success) {
                const files = result.data.data.files;
                const pagination = result.data.data.pagination;
                showResult('apiResult', `æ–‡ä»¶åˆ—è¡¨è·å–æˆåŠŸï¼\næ–‡ä»¶æ•°é‡: ${files.length}\næ€»è®¡: ${pagination.total}\né¡µæ•°: ${pagination.totalPages}`, 'success');
            } else {
                showResult('apiResult', `æ–‡ä»¶åˆ—è¡¨è·å–å¤±è´¥ï¼\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${result.data?.error || result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }

        // æµ‹è¯•ç”¨æˆ·æ›´æ–°
        async function testUserUpdate() {
            if (!sessionId) {
                showResult('userOpResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const userId = document.getElementById('testUserId').value;
            if (!userId) {
                showResult('userOpResult', 'è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
                return;
            }

            const result = await apiRequest('/api/admin/users', {
                method: 'PUT',
                body: JSON.stringify({ 
                    userId: parseInt(userId), 
                    role: 'user' 
                })
            });
            
            if (result.ok && result.data.success) {
                showResult('userOpResult', `ç”¨æˆ·æ›´æ–°æˆåŠŸï¼\nç”¨æˆ·ID: ${userId}\næ“ä½œ: è®¾ä¸ºæ™®é€šç”¨æˆ·`, 'success');
            } else {
                showResult('userOpResult', `ç”¨æˆ·æ›´æ–°å¤±è´¥ï¼\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${result.data?.error || result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }

        // æµ‹è¯•ç”¨æˆ·åˆ é™¤
        async function testUserDelete() {
            if (!sessionId) {
                showResult('userOpResult', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const userId = document.getElementById('testUserId').value;
            if (!userId) {
                showResult('userOpResult', 'è¯·è¾“å…¥ç”¨æˆ·ID', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ·ID ${userId} å—ï¼Ÿè¿™åªæ˜¯æµ‹è¯•ï¼Œè¯·è°¨æ…æ“ä½œï¼`)) {
                return;
            }

            const result = await apiRequest(`/api/admin/users?userId=${userId}`, {
                method: 'DELETE'
            });
            
            if (result.ok && result.data.success) {
                showResult('userOpResult', `ç”¨æˆ·åˆ é™¤æˆåŠŸï¼\nç”¨æˆ·ID: ${userId}`, 'success');
            } else {
                showResult('userOpResult', `ç”¨æˆ·åˆ é™¤å¤±è´¥ï¼\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${result.data?.error || result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }

        // æµ‹è¯•ç½‘ç»œè¿æ¥
        async function testNetworkConnectivity() {
            const tests = [
                { name: 'ä¸»é¡µ', url: '/' },
                { name: 'ç™»å½•API', url: '/api/auth/login' },
                { name: 'ä»ªè¡¨æ¿API', url: '/api/admin/dashboard' }
            ];

            let results = [];
            for (const test of tests) {
                try {
                    const start = Date.now();
                    const response = await fetch(test.url, { method: 'HEAD' });
                    const duration = Date.now() - start;
                    results.push(`${test.name}: ${response.status} (${duration}ms)`);
                } catch (error) {
                    results.push(`${test.name}: å¤±è´¥ - ${error.message}`);
                }
            }

            showResult('networkResult', `ç½‘ç»œè¿æ¥æµ‹è¯•ç»“æœï¼š\n${results.join('\n')}`, 'info');
        }

        // æµ‹è¯•CORS
        async function testCORS() {
            try {
                const response = await fetch('/api/admin/dashboard', {
                    method: 'OPTIONS'
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };

                showResult('networkResult', `CORSæµ‹è¯•ç»“æœï¼š\nçŠ¶æ€ç : ${response.status}\n${Object.entries(corsHeaders).map(([k,v]) => `${k}: ${v || 'æœªè®¾ç½®'}`).join('\n')}`, 'info');
            } catch (error) {
                showResult('networkResult', `CORSæµ‹è¯•å¤±è´¥ï¼š${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºç½‘ç»œä¿¡æ¯
        function showNetworkInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'è¯­è¨€': navigator.language,
                'å¹³å°': navigator.platform,
                'åœ¨çº¿çŠ¶æ€': navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿',
                'å½“å‰URL': window.location.href,
                'åè®®': window.location.protocol,
                'ä¸»æœº': window.location.host
            };

            showResult('networkResult', `ç½‘ç»œä¿¡æ¯ï¼š\n${Object.entries(info).map(([k,v]) => `${k}: ${v}`).join('\n')}`, 'info');
        }

        // æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        function showSystemInfo() {
            const info = {
                'æµè§ˆå™¨': navigator.userAgent,
                'è¯­è¨€': navigator.language,
                'å¹³å°': navigator.platform,
                'å±å¹•åˆ†è¾¨ç‡': `${screen.width}x${screen.height}`,
                'çª—å£å¤§å°': `${window.innerWidth}x${window.innerHeight}`,
                'æ—¶åŒº': Intl.DateTimeFormat().resolvedOptions().timeZone,
                'å½“å‰æ—¶é—´': new Date().toLocaleString('zh-CN'),
                'Cookieå¯ç”¨': navigator.cookieEnabled ? 'æ˜¯' : 'å¦'
            };

            if (performance.memory) {
                info['å†…å­˜ä½¿ç”¨'] = `${Math.round(performance.memory.usedJSHeapSize / 1024 / 1024)} MB`;
                info['å†…å­˜é™åˆ¶'] = `${Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)} MB`;
            }

            showResult('systemResult', `ç³»ç»Ÿä¿¡æ¯ï¼š\n${Object.entries(info).map(([k,v]) => `${k}: ${v}`).join('\n')}`, 'info');
        }

        // æ˜¾ç¤ºæ§åˆ¶å°é”™è¯¯
        function showConsoleErrors() {
            if (consoleErrors.length === 0) {
                showResult('systemResult', 'æ²¡æœ‰æ•è·åˆ°æ§åˆ¶å°é”™è¯¯', 'success');
            } else {
                const errorText = consoleErrors.map(err => `[${err.timestamp}] ${err.message}`).join('\n');
                showResult('systemResult', `æ§åˆ¶å°é”™è¯¯ (${consoleErrors.length}æ¡)ï¼š\n${errorText}`, 'error');
            }
        }

        // åˆå§‹åŒ–
        updateAuthStatus();
    </script>
</body>
</html>